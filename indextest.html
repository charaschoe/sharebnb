<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treemap Visualization</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #treemap-container {
            width: 700px;
            height: 500px;
            margin: 0 auto;
        }
        #percentage-output {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="treemap-container"></div>
    <div id="percentage-output"></div>

    <script type="module">
        import * as d3 from "https://cdn.skypack.dev/d3@7";
        import { tokyoData } from "../data/tokyo.js";

        const width = 700;
        const height = 500;

        const color = d3.scaleOrdinal()
            .domain(["1", "2", "3", "4", "5+"])
            .range(["#fff", "#E5E5E5", "#858585", "#b3b3b3", "#666666"]);

        const svg = d3
            .select("#treemap-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("font-family", "Inter, sans-serif");

        const data = tokyoData;

        const hostListingsData = d3.rollup(
            data,
            (v) => v.length,
            (d) => d.calculated_host_listings_count >= 5 ? "5+" : d.calculated_host_listings_count.toString()
        );

        const totalEntries = data.length;
        const entireHomeCount = hostListingsData.get("Entire home/apt") || 0;
        const percentageEntireHome = ((entireHomeCount / totalEntries) * 100).toFixed(2);

        d3.select("#percentage-output")
            .text(`In ${percentageEntireHome}% der Zeit hast du ein Appartment fÃ¼r dich alleine.`);

        const root = d3
            .hierarchy({ children: Array.from(hostListingsData, ([key, value]) => ({ name: key, value })) })
            .sum((d) => d.value)
            .sort((a, b) => b.value - a.value);

        d3.treemap().size([width, height]).padding(2)(root);

        const node = svg
            .selectAll("g")
            .data(root.leaves())
            .enter()
            .append("g")
            .attr("transform", (d) => `translate(${d.x0},${d.y0})`);

        node
            .append("rect")
            .attr("width", (d) => d.x1 - d.x0)
            .attr("height", (d) => d.y1 - d.y0)
            .attr("fill", (d) => color(d.data.name));

        node
            .append("text")
            .attr("x", 10)
            .attr("y", 20)
            .text((d) => `Listings: ${d.data.name}: ${d.value}`)
            .attr("fill", "#000")
            .style("font-size", "14px")
            .style("font-weight", "bold");

        function drawInitialTreemap() {
            const root = d3
                .hierarchy({ children: Array.from(hostListingsData, ([key, value]) => ({ name: key, value })) })
                .sum((d) => d.value)
                .sort((a, b) => b.value - a.value);

            d3.treemap().size([width, height]).padding(2)(root);

            const node = svg.selectAll("g").data(root.leaves());

            node
                .enter()
                .append("g")
                .merge(node)
                .attr("transform", (d) => `translate(${d.x0},${d.y0})`)
                .each(function (d) {
                    const g = d3.select(this);

                    g.selectAll("rect")
                        .data([d])
                        .enter()
                        .append("rect")
                        .merge(g.selectAll("rect"))
                        .attr("width", (d) => d.x1 - d.x0)
                        .attr("height", (d) => d.y1 - d.y0)
                        .attr("fill", (d) => color(d.data.name));

                    g.selectAll("text")
                        .data([d])
                        .enter()
                        .append("text")
                        .merge(g.selectAll("text"))
                        .attr("x", 10)
                        .attr("y", 20)
                        .text((d) => `Listings: ${d.data.name}: ${d.value} AirbnBs`)
                        .attr("fill", "#000")
                        .style("font-size", "14px")
                        .style("font-weight", "lighter");
                });

            node.exit().remove();

            node.on("click", (event, d) => {
                updateTreemap(d.data.name);
            });
        }

        drawInitialTreemap();
    </script>
</body>
</html>
